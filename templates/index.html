<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Модель АТС - Анализ авиационных катастроф</title>
  <style>
    :root{
      --bg:#f5f7fa; --panel:#ffffff; --muted:#6c757d; --text:#212529; --accent:#4c93ff; --border:#dee2e6;
      --error:#dc3545; --success:#28a745;
    }
    body { 
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
      margin: 0; 
      background: var(--bg);
      color: var(--text);
      font-size: 13px;
    }
    .container{ max-width: 1600px; margin: 0 auto; padding: 15px; }
    header { margin-bottom: 12px; }
    header h1{ margin: 0 0 6px 0; font-size: 18px; }
    header p{ margin: 0; color: var(--muted); font-size: 12px; }
    .toolbar{ display:flex; align-items:center; gap:10px; margin: 12px 0 15px; }
    button { 
      padding: 6px 12px; 
      font-size: 13px; 
      background: var(--accent); 
      color:white; 
      border:none; 
      border-radius:5px; 
      cursor:pointer; 
    }
    a.link{ color: var(--accent); text-decoration: none; font-size: 12px; }
    .tabs{ 
      position:sticky; 
      top:0; 
      background: rgba(255,255,255,0.95); 
      backdrop-filter: blur(4px); 
      display:flex; 
      gap:5px; 
      margin-bottom:10px; 
      flex-wrap:wrap; 
      padding:6px 0; 
      z-index:5; 
      border-bottom: 1px solid var(--border);
    }
    .tabbtn{ 
      background:transparent; 
      border:1px solid var(--border); 
      color:var(--text); 
      padding:5px 8px; 
      border-radius:5px; 
      cursor:pointer; 
      font-size: 12px;
    }
    .tabbtn.active{ 
      background: var(--accent); 
      border-color: var(--accent); 
      color: white;
    }
    .tab{ display:none; }
    .tab.active{ display:block; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 12px; }
    .card { 
      background: white; 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 10px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .card h3{ margin: 2px 4px 8px; font-size: 14px; color: var(--text); }
    .card img { width: 100%; height: auto; display:block; border-radius: 5px; }
    .error{ color: var(--error); margin:6px 0; font-size: 12px; }
    .success{ color: var(--success); margin:6px 0; font-size: 12px; }
    input{ 
      background: white; 
      color: var(--text); 
      border: 1px solid var(--border); 
      padding: 2px 3px; 
      border-radius: 3px; 
      outline: none; 
      width: 100%; 
      box-sizing: border-box; 
      font-size: 11px;
      max-width: 60px;
      text-align: center;
      height: 20px;
    }
    input:focus{ 
      border-color: var(--accent); 
      box-shadow: 0 0 0 2px rgba(76,147,255,0.2); 
    }
    .section-title{
      margin: 15px 2px 15px !important;
      font-weight: 600;
      color: #495057;
      font-size: 13px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .scrollbox{ 
      max-height: 350px; 
      overflow: auto; 
      border: 1px solid var(--border); 
      padding: 5px; 
      border-radius: 5px; 
      background: rgba(0,0,0,0.02); 
    }
    .nowrap{ white-space: nowrap; }
    .ulabel{ 
      white-space: normal; 
      overflow: hidden; 
      text-overflow: ellipsis; 
      font-size: 11px;
    }
    .u-table {
      display: grid;
      gap: 4px;
    }
    .u-header-row {
      display: grid;
      grid-template-columns: 500px 55px 55px;
      gap: 8px;
      align-items: center;
      font-weight: 600;
      color: var(--text);
      font-size: 11px;
      padding-bottom: 4px;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      text-align: center;
    }
    .u-header-row .label {
      text-align: left;
    }
    .u-row {
      display: grid;
      grid-template-columns: 500px 55px 55px;
      gap: 8px;
      align-items: center;
      font-size: 11px;
      padding: 3px 0;
      border-bottom: 1px solid rgba(0,0,0,0.03);
    }
    .u-row .ulabel {
      text-align: left;
    }
    .u-row input {
      background: white;
      color: var(--text);
      border: 1px solid var(--border);
      padding: 2px 3px;
      border-radius: 3px;
      outline: none;
      width: 100%;
      box-sizing: border-box;
      font-size: 11px;
      text-align: center;
      height: 20px;
    }
    .u-row input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 1);
    }
    .chip{ 
      display: inline-block; 
      padding: 1px 4px; 
      border-radius: 2px; 
      border: 1px solid var(--border); 
      background: rgba(0,0,0,0.03); 
      font-feature-settings: "tnum" on, "lnum" on; 
      font-size: 10px;
      min-width: 18px;
      text-align: center;
    }
    .chip.mono{ 
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; 
      letter-spacing: .2px; 
    }
    .var-label {
      font-weight: 600;
      color: var(--accent);
      font-size: 11px;
    }
    .compact-grid {
      display: grid;
      gap: 8px;
    }
    .fak-container {
      display: grid;
      gap: 8px;
    }
    .fak-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px;
      border: 1px solid var(--border);
      border-radius: 5px;
      background: rgba(0,0,0,0.02);
      flex-wrap: wrap;
    }
    .fak-label {
      font-size: 11px;
      font-weight: 600;
      color: #212529;
      white-space: nowrap;
      min-width: 50px;
    }
    .fak-formula {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      flex-wrap: wrap;
    }
    .fak-input-group {
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .fak-input-group input {
      max-width: 60px;
    }
    .formula-text {
      font-size: 11px;
      color: var(--text);
      white-space: nowrap;
    }
    .eq-row {
      display: grid;
      grid-template-columns: 40px 20px 25px 10px 30px;
      gap: 2px;
      align-items: center;
      font-size: 11px;
      padding: 4px 0;
      border-bottom: 1px solid rgba(0,0,0,0.03);
    }
    .u-var {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 10px;
      color: var(--text);
      font-weight: 600;
    }
    .graph-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 6px 0;
      font-size: 11px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .legend-color {
      width: 10px;
      height: 10px;
      border-radius: 2px;
    }
    .diagram-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 8px;
    }
    .fak-description {
      margin-top: 10px;
      padding: 8px;
      background: rgba(0,0,0,0.03);
      border-radius: 5px;
      font-size: 11px;
    }
    .fak-description h4 {
      margin: 0 0 5px 0;
      font-size: 12px;
      color: var(--accent);
    }
    .fak-description ul {
      margin: 0;
      padding-left: 15px;
    }
    .fak-description li {
      margin-bottom: 2px;
    }
    .limit-note {
      font-size: 10px;
      color: var(--muted);
      margin-top: 5px;
      font-style: italic;
    }
    
    .time-info {
      background: #e7f1ff;
      border-left: 3px solid var(--accent);
      padding: 8px;
      margin: 10px 0;
      border-radius: 3px;
      font-size: 11px;
    }
  </style>
  <link rel="icon" href="data:," />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <script>
    function runNow() {
      document.getElementById('runBtn').disabled = true;
      document.getElementById('runBtn').innerText = 'Выполняется...';
      document.getElementById('runForm').submit();
    }
    document.addEventListener('DOMContentLoaded', function(){
      const btns = document.querySelectorAll('.tabbtn');
      const tabs = document.querySelectorAll('.tab');
      btns.forEach(btn => btn.addEventListener('click', () => {
        btns.forEach(b => b.classList.remove('active'));
        tabs.forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        const id = btn.getAttribute('data-tab');
        document.getElementById(id).classList.add('active');
      }));
    });
    function toSubscript(num) {
      const digits = '₀₁₂₃₄₅₆₇₈₉';
      return num.toString().split('').map(d => digits[parseInt(d)]).join('');
    }
  </script>
</head>
<body>
  <div class="container">
    <header>
      <h1>Модель АТС - Анализ авиационных катастроф</h1>
      <p>Моделирование системы авиационной транспортной безопасности на основе системно-динамического подхода</p>
    </header>
    <div class="toolbar">
      <button id="runBtn" type="submit" form="fullForm">Вычислить</button>
      <a class="link" href="?run=1">Заполнить случайными и вычислить</a>
    </div>
    {% if error %}
      <div class="error">Ошибка: {{ error }}</div>
    {% endif %}
    {% if success %}
      <div class="success">{{ success }}</div>
    {% endif %}
    <div class="tabs">
      <button class="tabbtn active" data-tab="tab-params">Параметры</button>
      <button class="tabbtn" data-tab="tab-graphs">Графики</button>
      <button class="tabbtn" data-tab="tab-diagrams">Диаграмма</button>
      <button class="tabbtn" data-tab="tab-faks">Возмущение</button>
    </div>
    <div id="tab-params" class="tab active">
      <div class="grid">
        <div class="card">
          <form id="fullForm" method="post">
            <h3 class="section-title">Возмущения </h3>
            <div class="fak-container">
                {% for fid in range(1,6) %}
                  <div class="fak-item">
                    <div class="fak-label">F{{ fid }}(t) =</div>
                    <div class="fak-formula">
                      <span >{{ (values.faks[loop.index0][0] if values else defaults.faks[loop.index0][0]) }}</span>
                      <span class="formula-text">+</span>
                      <span >{{ (values.faks[loop.index0][1] if values else defaults.faks[loop.index0][1]) }}</span>
                      <span class="formula-text">· t</span>
                    </div>
                  </div>
                {% endfor %}
              </div>
              
            <h3 class="section-title">Начальные условия и ограничения переменных</h3>
            <div class="u-table">
              <div class="u-header-row">
                <div class="u-col label">Характеристика</div>
                <div class="u-col center">Начальное условие</div>
                <div class="u-col center">Предел</div>
              </div>
              {% for i in range(1,9) %}
                <div class="u-row">
                  <div class="ulabel">{{ u_labels[i-1] }}</div>
                  <input name="u{{ i }}" 
                    value="{{ (values.u[i-1] if values else defaults.u[i-1]) }}" 
                    maxlength="4" placeholder="0.1" />
              <input name="u_restrictions{{ i }}" 
                    value="{{ (values.u_restrictions[i-1] if values else defaults.u_restrictions[i-1]) }}" 
                    maxlength="4" placeholder="1.0" />
                </div>
              {% endfor %}
            </div>
            
            <h3 class="section-title">Уравнения характеристик</h3>
            <div class="fak-description">
              <p>Коэффициенты получены через регрессионный анализ: fᵢ(x) = k·x + b</p>
            </div>
            <div class="scrollbox">
              <div class="compact-grid">
                {% for i in range(1, 19) %}
                  {% set u_var = get_u_variable_for_equation(i) %}
                  {% set u_subscript = u_var | subscript %}
                  <div class="eq-row">
                    <div class="nowrap">f{{ i | subscript }}(X{{ u_subscript }}) =</div>
                    <span>{{ (values.equations[i-1][0] if values else defaults.equations[i-1][0]) }}</span>
                    <div >× X{{ u_subscript }}</div>
                    <div class="nowrap">+</div>
                    <span>{{ (values.equations[i-1][1] if values else defaults.equations[i-1][1]) }}</span>
                  </div>
                {% endfor %}
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div id="tab-graphs" class="tab">
      {% if ran %}
      <div class="graph-row">
        <div class="card">
          <h3>X₁–X₈</h3>
          <img src="data:image/png;base64,{{ images_b64.figure1 }}" alt="График переменных X1-X8" />
        </div>
      </div>
      {% else %}
        <div class="card">Заполните начальные значения и нажмите «Вычислить»</div>
      {% endif %}
    </div>
    <div id="tab-diagrams" class="tab">
      {% if ran %}
      <div class="diagram-row">
        <div class="card"><h3>Начало</h3><img src="data:image/png;base64,{{ images_b64.diagram1 }}" /></div>
        <div class="card"><h3>1/4</h3><img src="data:image/png;base64,{{ images_b64.diagram2 }}" /></div>
        <div class="card"><h3>1/2</h3><img src="data:image/png;base64,{{ images_b64.diagram3 }}" /></div>
        <div class="card"><h3>3/4</h3><img src="data:image/png;base64,{{ images_b64.diagram4 }}" /></div>
        <div class="card"><h3>Конец</h3><img src="data:image/png;base64,{{ images_b64.diagram5 }}" /></div>
      </div>
      {% else %}
        <div class="card">Заполните начальные значения и нажмите «Вычислить»</div>
      {% endif %}
    </div>
    <div id="tab-faks" class="tab">
      {% if ran %}
        <div class="card">
          <h3>Внешние факторы системы АТС</h3>
          <img src="data:image/png;base64,{{ images_b64.figure2 }}" alt="График внешних факторов" />
          <div class="limit-note">* Все возмущения ограничены диапазоном [0, 1]</div>
          <div class="fak-description">
            <div class="legend">
            <div class="legend-item"><div class="legend-color" style="background: #1f77b4;"></div>F₁: Средняя выработка ресурса до списания</div>
            <div class="legend-item"><div class="legend-color" style="background: #ff7f0e;"></div>F₂: Доля иностранных воздушных судов</div>
            <div class="legend-item"><div class="legend-color" style="background: #2ca02c;"></div>F₃: Средний лётный стаж пилотов</div>
            <div class="legend-item"><div class="legend-color" style="background: #d62728;"></div>F₄: Стоимость авиационного топлива</div>
            <div class="legend-item"><div class="legend-color" style="background: #9467bd;"></div>F₅: Количество нормативно-правовых актов</div>
          </div>
          </div>
        </div>
      {% else %}
        <div class="card">Заполните начальные значения и нажмите «Вычислить»</div>
      {% endif %}
    </div>
  </div>
</body>
</html>

